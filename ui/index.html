<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OP‑XY Conductor – UI</title>
    <style>
      body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; color: #111; }
      h1 { margin: 0 0 8px; font-size: 18px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
      button { padding: 6px 10px; font-size: 14px; }
      input[type="number"] { width: 80px; padding: 4px; }
      #status { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color: #444; }
      .tracks { display: grid; gap: 12px; margin-top: 12px; }
      .track { border: 1px solid #ddd; border-radius: 6px; padding: 8px; }
      .track h3 { margin: 0 0 6px; font-size: 14px; display: flex; justify-content: space-between; }
      .grid { display: grid; gap: 2px; }
      .cell { width: 16px; height: 16px; background: #eee; border-radius: 3px; }
      .cell.on { background: #5aa7ff; }
      .cell.v-hi { background: #0057ff; }
      .cell.v-mid { background: #4d8dff; }
      .cell.v-low { background: #a7c7ff; }
      .dk { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background: #fafafa; padding: 6px; border-radius: 4px; border: 1px dashed #ddd; white-space: pre; overflow-x: auto; }
      .pill { font-size: 11px; padding: 2px 6px; border-radius: 999px; background: #f2f2f2; margin-left: 6px; }
    </style>
  </head>
  <body>
    <h1>OP‑XY Conductor – Local UI</h1>
    <div class="row">
      <button id="btnPlay">Play</button>
      <button id="btnStop">Stop</button>
      <button id="btnCont">Continue</button>
      <label>BPM <input id="bpm" type="number" value="100" min="20" max="300" /></label>
      <button id="btnPushTempo">Push tempo</button>
      <span id="status"></span>
    </div>

    <div id="meta"></div>
    <div class="tracks" id="tracks"></div>

    <script>
      const wsUrl = 'ws://127.0.0.1:8765';
      let ws; let lastDoc = null; let lastState = null;
      const status = document.getElementById('status');
      function setStatus(s) { status.textContent = s; }

      function connect() {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => setStatus('WS connected');
        ws.onclose = () => setStatus('WS disconnected');
        ws.onmessage = (ev) => {
          try { const msg = JSON.parse(ev.data); handle(msg); } catch {}
        };
        // Fallback poll: request state every 1s in case server isn't pushing
        setInterval(() => { try { ws && ws.readyState === 1 && ws.send(JSON.stringify({type:'getState'})); } catch(e){} }, 1000);
      }

      function handle(msg) {
        if (msg.type === 'doc') { lastDoc = msg.payload; renderDoc(); }
        if (msg.type === 'state') { lastState = msg.payload; renderState(); }
        if (msg.type === 'metrics') { /* could render later */ }
      }

      function renderState() {
        if (!lastState) return;
        const { transport, bpm, barBeatTick, clockSource } = lastState;
        const bbt = barBeatTick ? ` beat=${barBeatTick.beat} tickInBar=${barBeatTick.tickInBar}/${barBeatTick.barTicks}` : '';
        setStatus(`clock=${clockSource||'internal'} transport=${transport} bpm=${bpm}${bbt}`);
        // Reflect external tempo changes in the BPM input as well
        const bpmInput = document.getElementById('bpm');
        // Do not clobber user's typing when the field has focus
        if (bpm && bpmInput && document.activeElement !== bpmInput) {
          bpmInput.value = (Math.round(bpm * 10) / 10).toFixed(1);
        }
        // (no clock toggle button in simplified UI)
      }

      function renderDoc() {
        if (!lastDoc) return;
        const wrap = document.getElementById('tracks');
        wrap.innerHTML = '';
        const meta = lastDoc.json.meta || {}; const spb = meta.stepsPerBar || 16; const ppq = meta.ppq || 96;
        document.getElementById('bpm').value = (lastState && lastState.bpm) || (meta.tempo || 120);
        const metaDiv = document.getElementById('meta');
        metaDiv.textContent = `docVersion=${lastDoc.docVersion} sha=${lastDoc.sha256?.slice(0,8)}`;

        const tracks = (lastDoc.json.tracks || []);
        tracks.forEach((tr, ti) => {
          const div = document.createElement('div'); div.className = 'track';
          const h3 = document.createElement('h3');
          const left = document.createElement('span'); left.textContent = `${tr.name || tr.id || 'Track'} (ch ${tr.midiChannel ?? 0})`;
          const right = document.createElement('span'); right.className = 'pill'; right.textContent = tr.type || 'sampler';
          h3.appendChild(left); h3.appendChild(right); div.appendChild(h3);

          // Steps grid (pattern.steps) — render only if steps exist and this is not a drumKit-only track
          const pat = tr.pattern || {}; const steps = Array.isArray(pat.steps) ? pat.steps : []; const bars = Math.max(1, pat.lengthBars || 1);
          if (steps.length > 0 && !(tr.drumKit && Array.isArray(tr.drumKit.patterns))) {
            const total = bars * spb;
            const vals = Array(total).fill(0);
            steps.forEach(st => {
              const idx = st && typeof st.idx === 'number' ? st.idx|0 : -1; const events = (st && st.events) || [];
              if (idx >= 0 && events.length) {
                const v = Math.max(1, Math.min(127, events[0].velocity || 100));
                vals[(idx % total)] = v;
              }
            });
            // Only draw if at least one step is active
            if (vals.some(x => x > 0)) {
              const grid = document.createElement('div'); grid.className = 'grid';
              grid.style.gridTemplateColumns = `repeat(${total}, 16px)`;
              for (let i=0;i<total;i++) {
                const c = document.createElement('div'); c.className = 'cell';
                const v = vals[i]; if (v>0){ c.classList.add('on'); if (v>=105) c.classList.add('v-hi'); else if (v>=70) c.classList.add('v-mid'); else c.classList.add('v-low'); }
                if (i % spb === 0) { c.style.outline = '1px solid #ddd'; }
                grid.appendChild(c);
              }
              div.appendChild(grid);
            }
          }

          // DrumKit patterns, if any – render as 16-step grid by hit type (rows)
          if (tr.drumKit && Array.isArray(tr.drumKit.patterns)) {
            const specs = tr.drumKit.patterns;
            const normalize = (s) => String(s||'').toLowerCase();
            const alias = (k) => ({ 'ch':'closed_hat','oh':'open_hat','hh':'closed_hat' }[k]||k);
            // Canonical drum rows (order)
            const rows = [
              { id:'kick', label:'kick' }, { id:'kick_alt', label:'kick_alt' },
              { id:'snare', label:'snare' }, { id:'snare_alt', label:'snare_alt' },
              { id:'rim', label:'rim' }, { id:'clap', label:'clap' },
              { id:'tambourine', label:'tamb' }, { id:'shaker', label:'shaker' },
              { id:'closed_hat', label:'hh' }, { id:'open_hat', label:'oh' }, { id:'pedal_hat', label:'ph' },
              { id:'low_tom', label:'lt' }, { id:'mid_tom', label:'mt' }, { id:'high_tom', label:'ht' },
              { id:'crash', label:'crash' }, { id:'ride', label:'ride' },
              { id:'cowbell', label:'cow' }, { id:'conga_low', label:'cl' }, { id:'conga_high', label:'ch' },
              { id:'guiro', label:'guiro' }, { id:'metal', label:'metal' }, { id:'chi', label:'chi' },
            ];
            // Build map key->pattern string for current bar = 1
            const byKey = new Map();
            for (const s of specs) {
              const key = alias(normalize(s.key||''));
              const bar = s.bar||1;
              if (!s.pattern || typeof s.pattern !== 'string') continue;
              if (bar !== 1) continue; // first pass: show bar 1
              byKey.set(key, String(s.pattern));
            }
            // Append any unknown keys as extra rows
            for (const s of specs) {
              const k = alias(normalize(s.key||''));
              if (!rows.find(r=>r.id===k)) rows.push({ id:k, label:k });
            }
            // Container
            const cont = document.createElement('div');
            cont.style.marginTop = '8px';
            // Render rows
            rows.forEach(r => {
              const patt = byKey.get(r.id);
              if (!patt) return; // skip empty rows
              const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.margin='2px 0';
              const lab = document.createElement('div'); lab.textContent = r.label; lab.style.width='64px'; lab.style.textAlign='right'; lab.style.fontSize='12px'; lab.style.color='#555';
              row.appendChild(lab);
              const g = document.createElement('div'); g.className='grid'; g.style.gridTemplateColumns = `repeat(${spb}, 16px)`;
              for (let i=0;i<spb;i++){
                const c = document.createElement('div'); c.className='cell';
                if (i < patt.length && patt[i] === 'x') c.classList.add('on','v-mid');
                if (i % spb === 0) c.style.outline='1px solid #ddd';
                g.appendChild(c);
              }
              row.appendChild(g); cont.appendChild(row);
            });
            div.appendChild(cont);
          }

          wrap.appendChild(div);
        });
      }

      // Controls
      document.getElementById('btnPlay').onclick = () => ws && ws.send(JSON.stringify({type:'play'}));
      document.getElementById('btnStop').onclick = () => ws && ws.send(JSON.stringify({type:'stop'}));
      document.getElementById('btnCont').onclick = () => ws && ws.send(JSON.stringify({type:'continue'}));
      // Simplified: Push tempo sends CC80 mapping; device remains master
      document.getElementById('btnPushTempo').onclick = () => {
        if (!ws || ws.readyState !== 1) return;
        const bpmField = document.getElementById('bpm');
        const bpm = parseFloat(bpmField.value||'120');
        if (!isFinite(bpm) || bpm <= 0) return;
        ws.send(JSON.stringify({type:'setTempoCC', bpm}));
      };

      connect();
    </script>
  </body>
  </html>
